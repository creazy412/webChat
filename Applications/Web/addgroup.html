<div class="add-group-struct"></div>
<div class="add-group-tool">
	<i class="chat-icon target-right">添加</i>
	<i class="chat-icon target-left">移除</i>
</div>
<div class="group-member"></div>
<a href="javascript:;" class="create-group button float-right">确定</a>
<script>
	var chatuser = $('.recent span[data-id='+$('.contact-msg').attr('chatuser')+']')
	if(chatuser.attr('type')=='group') {
		//group
		chatuser.next().children('span').clone().appendTo($('.group-member'))
	}else{
		//self
		$('<span/>').addClass('no-child undelete').attr({'type':'personal','data-id':user.dataid}).html('<img class="avatar" width="22px" src='+user.avatar+'>'+user.name).appendTo($('.group-member'))
		//chatuser
		chatuser.clone().addClass('undelete').find('.unread').remove().end().appendTo($('.group-member'))
	}
	$('.structure').clone().find('.tree-icon').remove().end().children().appendTo($('.add-group-struct'))
	$('.add-group-struct').treeViewModify({})
	$('.add-group-struct span:not(.no-child)').append('<a href="javascript:;" class="add-group-all">+</a>')
	$('.add-group-struct').on('mouseover','span:not(.no-child)',function(){$(this).children('.add-group-all').show()}).on('mouseout','span:not(.no-child)',function(){$(this).children('.add-group-all').hide()})
	$('.add-group-struct').on('click','.add-group-all',function(){
		$(this).parent().next().find('span.no-child[type=member]').each(function(){
			if($('.group-member span[data-id='+$(this).attr('data-id')+']').length == 0)
				$(this).clone().appendTo($('.group-member'));
		})
	})
	$('.add-group-struct').on('click','span.no-child[type=member]',function(){
		if($('.group-member span[data-id='+$(this).attr('data-id')+']').length == 0)
                                $(this).clone().appendTo($('.group-member'));	
	})
	$('.group-member').on('click','span:not(.undelete)',function(){
		$(this).remove();
	})
	$('.create-group').click(function(){
		if($('.group-member span').length <= 1)
			return false;
		var member = [];
		$('.group-member span').each(function(){
			member.push({'username':$(this).html().replace(/<[^>]+>/,''),'avatar':$(this).find('img').attr('src'),'attr':{'type':'member','data-id':$(this).attr('data-id'),'class':$(this).find('.avatar').hasClass('no-login') ? 'no-login' : ''}});
		})
		$('.recent').addTree({
			'title':$('.group-member').html().replace(/<[^>]+><[^>]+>([^<]*)<\/[^>]+>/g,',$1').substr(1),
			'member':member,
			'attr':{'type':'group','data-id':user.dataid+'-'+new Date().getTime()}
		})
		$('.recent span:first').dblclick();
		$('.modal-close').click();
	})
</script>
